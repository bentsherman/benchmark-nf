manifest {
	mainScript = "main.nf"
	defaultBranch = "master"
	nextflowVersion = ">=20.01.0"
}



env {
	PATH = "${PATH}:${PWD}/bin"
}



params {
	input {
		dir = "kinc/input"
		emx_files = "*.emx"
		conditions_file = "conditions.txt"
		trials = 3
	}

	output {
		dir = "kinc/output"
	}
}



report {
	enabled = true
	file = "${params.output.dir}/reports/report.html"
}



timeline {
	enabled = true
	file = "${params.output.dir}/reports/timeline.html"
}



trace {
	enabled = true
	fields = "task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes"
	file = "${params.output.dir}/reports/trace.txt"
	raw = true
}



docker {
	runOptions = "--init --runtime=nvidia"
}



singularity {
	runOptions = "--bind \$TMPDIR --nv"
	autoMounts = true
	cacheDir = "work-singularity"
}



process {
	container = "systemsgenetics/kinc:3.3.0"
	echo = false
	errorStrategy = "ignore"
}



profiles {
	standard {
		process {
			executor = "local"
			cpus = { c.np }
			memory = "8 GB"

			afterScript = "rm -f *.ccm *.cmx"
		}
		executor {
			queueSize = 1
		}
	}

	testing {
		process.errorStrategy = "terminate"
	}

	pbs {
		process {
			executor = "pbspro"
			time = "24h"

			afterScript = "rm -f *.ccm *.cmx"

			withName:run_experiment {
				clusterOptions = {
					(c.gpu_model == "cpu")
					? "-l select=${c.np.toInteger().intdiv(2) + 1}:ncpus=2:mpiprocs=2:mem=8gb:phase=16"
					: "-l select=${c.np.toInteger().intdiv(2) + 1}:ncpus=${(c.threads.toInteger()) * 2 + 1}:mpiprocs=2:mem=8gb:ngpus=2:gpu_model=${c.gpu_model}"
				}
			}
		}
		executor {
			queueSize = 50
		}
	}
}
