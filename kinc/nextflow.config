manifest {
	mainScript = "main.nf"
	defaultBranch = "master"
	nextflowVersion = ">=19.04.0"
}



params {
	input {
		dir = "kinc/input"
		emx_files = "*.emx"
		gpu_models = ["p100", "v100"]
		trials = 3
	}

	output {
		dir = "kinc/output"
	}

	defaults {
		gpu_model = "p100"
		revision = "master"
		threads = 1
		clusmethod = "gmm"
		corrmethod = "spearman"
		preout = true
		postout = true
		bsize = 32768
		gsize = 4096
		lsize = 32
	}

	revision {
		enabled = false
		values = ["v3.3.0", "master"]
	}

	threads {
		enabled = false
		values = [1, 2, 3, 4, 5, 6, 7, 8]
	}

	bsize {
		enabled = false
		values = [1024, 2048, 4096, 8192, 16384, 32768]
	}

	gsize {
		enabled = false
		values = [1024, 2048, 4096, 8192, 16384, 32768]
	}

	lsize {
		enabled = false
		values = [16, 32, 64, 128, 256, 512, 1024]
	}

	scalability_v1 {
		enabled = false
		values = [1, 2, 4, 8]
	}

	scalability_cpu {
		enabled = false
		values = [1, 2, 4, 8]
	}

	scalability_gpu {
		enabled = false
		values = [1, 3, 5, 9]
	}
}



report {
	enabled = true
	file = "${params.output.dir}/reports/report.html"
}



timeline {
	enabled = true
	file = "${params.output.dir}/reports/timeline.html"
}



trace {
	enabled = true
	fields = "task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes"
	file = "${params.output.dir}/reports/trace.txt"
	raw = true
}



docker {
	runOptions = "--init --runtime=nvidia"
}



singularity {
	runOptions = "--bind \$TMPDIR --nv"
	autoMounts = true
	cacheDir = "work-singularity"
}



process {
	container = "systemsgenetics/kinc:3.3.0"
	errorStrategy = { task.attempt <= 2 ? "retry" : "ignore" }
	scratch = false

	afterScript = "rm -f *.ccm *.cmx"

	validExitStatus = [0, 134, 139, 143, 255]
}



profiles {
	standard {
		process {
			executor = "local"
			cpus = 1
			memory = "8 GB"

			beforeScript = "export TMPDIR=${PWD}"
		}
		executor {
			queueSize = 1
		}
	}

	testing {
		process.errorStrategy = "terminate"
	}

	pbs {
		process {
			executor = "pbspro"
			time = "72h"
			module = { "KINC/${params.defaults.revision}" }

			withName:revision {
				clusterOptions = { "-l select=1:ncpus=2:mpiprocs=1:mem=8gb:ngpus=2:gpu_model=${gpu_model}" }
				module = { "KINC/${revision}" }
			}
			withName:threads {
				clusterOptions = { "-l select=1:ncpus=${threads + 1}:mpiprocs=1:mem=8gb:ngpus=2:gpu_model=${gpu_model}" }
			}
			withName:bsize {
				clusterOptions = { "-l select=1:ncpus=${params.defaults.threads + 1}:mpiprocs=1:mem=8gb:ngpus=2:gpu_model=${gpu_model}" }
			}
			withName:gsize {
				clusterOptions = { "-l select=1:ncpus=${params.defaults.threads + 1}:mpiprocs=1:mem=8gb:ngpus=2:gpu_model=${gpu_model}" }
			}
			withName:lsize {
				clusterOptions = { "-l select=1:ncpus=${params.defaults.threads + 1}:mpiprocs=1:mem=8gb:ngpus=2:gpu_model=${gpu_model}" }
			}
			withName:scalability_v1 {
				clusterOptions = { "-l select=1:ncpus=${np}:mpiprocs=${np}:mem=32gb:ngpus=1:gpu_model=${params.defaults.gpu_model}" }
				module = "KINC/v1"
			}
			withName:scalability_cpu {
				clusterOptions = { "-l select=1:ncpus=${np + 1}:mpiprocs=${np + 1}:mem=8gb:ngpus=1:gpu_model=${params.defaults.gpu_model}" }
			}
			withName:scalability_gpu {
				clusterOptions = { "-l select=${np.intdiv(2) + 1}:ncpus=8:mpiprocs=2:mem=8gb:ngpus=2:gpu_model=${gpu_model}" }
			}
		}
		executor {
			queueSize = 100
		}
	}
}
